<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css"/>
    <title>essentia.js RMS Level</title>
    <link rel="stylesheet" type="text/css" href="/demos/styles/essentia-colors.css">
    <link rel="stylesheet" type="text/css" href="/demos/styles/demos.css">
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
    <script src="./mic-toggle-button.js"></script>
    <script type="module">

      import { createEssentiaNode } from "./essentia-worklet-node.js";

      let audioContext;
      let gumStream;

      let isRecording = false;

      let micNode = null;
      let essentiaNode = null;
      let analyserNode = null;
      let analyserData = null;

      let animationID;

      const rmsValue = document.querySelector("#rms-value");

      class Smoother {
        constructor(windowSize=10) {
          this.size = windowSize;
          this.buffer = new Array(this.size).fill(0);
          this.oldestVal = 0;
          this.sum = 0;
          this.firstTime = true;
        }

        lowpass(val) {
          // computes moving average
          this.buffer.push(val);
          this.oldestVal = this.buffer.shift();
          
          if (this.firstTime) {
            this.sum = this.buffer.reduce((acc, v) => acc + v);
            this.firstTime = false;
          } else {
            this.sum = (this.sum - this.oldestVal) + val;
          }
          const avg = this.sum / this.size;
          return Math.round(avg);
        }
      }

      const smoother = new Smoother(20);

      // show console.log on html div
      window.console.logToScreen = function(str) {
        let node = document.createElement("div");
        node.appendChild(document.createTextNode(str));
        document.getElementById("myLog").appendChild(node);
      };

      const audioButton = document.querySelector('mic-toggle-button');

      audioButton.addEventListener('click', function() {
        if(!isRecording) {
            audioContext = audioButton.audio.ctx;
            startEssentiaAnalyser(audioContext).then(()=>console.logToScreen('essentia analyzer started'));
            return;
        }
        if(isRecording) {
          gumStream.getAudioTracks().forEach((track) => {
            track.stop();
            gumStream.removeTrack(track);
          });
          console.logToScreen('Closing audio context ...');

          micNode.disconnect();
          analyserNode.disconnect();
          essentiaNode.disconnect();
          // micNode = null;
          // essentiaNode = null;

          cancelAnimationFrame(animationID);

          isRecording = false;
        }
      });

      function draw () {
        animationID = requestAnimationFrame(draw);
        analyserNode.getFloatTimeDomainData(analyserData);
        let rms = analyserData[0];
        let dbFS = 20 * Math.log10((rms + Number.EPSILON) * Math.sqrt(2));
        // lowpass value for easier visualization
        let smoothedVal = smoother.lowpass(dbFS);
        rmsValue.innerText = smoothedVal;
      }

      // connect the nodes
      async function startEssentiaAnalyser(audioContext) {
        async function setupAudioGraph(stream) {
          gumStream = stream;
          if (gumStream.active) {
            console.logToScreen('Sample Rate = ' + audioContext.sampleRate);
            micNode = audioContext.createMediaStreamSource(stream);
            analyserNode = audioContext.createAnalyser();
            analyserNode.fftSize = 2 * 128;
            analyserData = new Float32Array(analyserNode.frequencyBinCount);

            // create essentia node only once (avoid registering processor repeatedly)
            if (!essentiaNode) {
              console.logToScreen("Creating EssentiaNode instance ...")
              essentiaNode = await createEssentiaNode(audioContext);
            }

            console.logToScreen("Mic => essentiaWorklet => audioContext.destination ....");
            console.logToScreen("Calculating RMS level from microphone input ....");
            // connect mic stream to essentia node
            audioButton.connectToAudioNode(essentiaNode);
            // If it isn't connected to destination, the worklet is not executed
            essentiaNode.connect(analyserNode);

            draw(analyserData);

            isRecording = true;
          } else { 
            throw 'Mic stream not active'; 
          }
        }
        if (navigator.mediaDevices.getUserMedia) {
          document.getElementById("myLog").innerHTML = ""; // empty on-screen log
          console.logToScreen(".................................")
          console.logToScreen('Initializing mic input stream ...')
          navigator.mediaDevices.getUserMedia({audio: {sampleRate: {exact: audioContext.sampleRate }}, video: false}).then((stream) => {
            setupAudioGraph(stream);
          }).catch(function(message) {
            throw 'Could not access microphone - ' + message;
          });
        } else {throw 'Could not access microphone - getUserMedia not available';}
      }
    </script>

    <div class="ui header" style="background-color: var(--footer-header-dark-blue); margin: none;">
      <div class="ui container">
        <a href="https://github.com/MTG/essentia.js">
          <object data="/demos/assets/essentiajs-logo-4.0.svg" type="image/svg+xml" width="230" height="50"></object>
        </a>
      </div>
    </div>

    <div class="ui container">
      <h1 class="ui center aligned huge dividing header">
        RMS Level
      </h1>
      <div class="ui centered row" style="font-size: 2rem;">
        <span class="">
          <mic-toggle-button></mic-toggle-button>
        </span>
        <span id="rms" class="" style="width: 30rem;">
          <span id="rms-value">0</span> <span>dBFS</span>
        </span>
      </div>
    </div>
    
    <footer style="background-color: var(--footer-header-dark-blue);">
      <div class="ui container">
        <div class="ui grid">
          <a target="_blank" href="//essentia.upf.edu" class="ui four wide column">
            <img id="logo" src="/demos/assets/essentia_logo.svg" alt="MTG Logo"
              style="margin-left: 40px; height: 70px;">
          </a>
          <a target="_blank" href="https://www.upf.edu/web/mtg" class="ui four wide column">
            <img src="/demos/assets/MTG_RGB_logo-02.svg" alt="mtg logo"
                style="height: 70px;">
          </a>
  
          <div class="ui eight wide column">
            <div class="ui content" style="color: white;">
              using
              <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioWorklet" style="color: #ededed; text-decoration: underline solid;">AudioWorklets</a>
            </div>
            <a href="https://github.com/MTG/essentia.js/tree/dev/examples/rms-rt" target="_blank" class="ui small button">
              See code on GitHub<i class="right github icon"></i>
            </a>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>