<!DOCTYPE html>
<html lang="en">
  <script> 
    var Module = {
      onRuntimeInitialized: function() {
            console.log('essentia.js loaded sucessfully ...');
            essentia = new Module.EssentiaJS(false);
            console.log('Essentia:', essentia.version, '- http://essentia.upf.edu');   
        }
    };
  </script>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css"/>
    <title>essentia.js with Web Audio API ScriptNodeProcessor example</title>
  </head>
      <body style="background-color:  #000000!important;"">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
        <script src="https://unpkg.com/essentia.js@0.0.8/dist/essentia.js"></script>
        <script src="es-script-node-processor.js"></script>
        <script src="essentiatools.js" type="module"></script>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        
        <div class="ui main_wrapper landing-image">

        <div class="ui header centered" id="header">
          <a href="index.html">
            <img id="header-img" src="../..//src/assets/img/essentiajsbanner.png">
          </a>
          <div>
              <h1 class="ui header white-text" style="color: azure;">WebAudioApi ScriptNodeProcessor example</h1>
              <h4 class="ui header white-text" style="color: azure;">PitchYinProbabilistic</h4>
          </div>

          <div class="ui basic large button">
            <a href="https://github.com/MTG/essentia.js/tree/module/examples/audio-worklets" target="_blank" class="ui small button">Code<i class="right github icon"></i></a>
          </div>

        </div>
        
        <div class="body-container">

          <div class="ui centered one column grid container">
            <div class="ui vertical buttons row">
              <center><button id="recordButton" class="ui red inverted big button record-button">Mic
                  &nbsp;&nbsp;<i class="microphone icon"></i></button></center>
            </div>

            <div id="plotDiv" class="ui centered segment" style="width: 650px; height: 300px; background-color: transparent"></div>

          </div>

        </div>

        <div class="ui diverder" style="height: 50px;"></div>
        
        <center>
        <div class="footer" style="margin-top: 30px; height: 20%;">
          <a class="demo_logo" target="_blank" href="//essentia.upf.edu">
            <img id="logo" src="https://essentia.upf.edu/documentation/_static/essentia_logo.svg" alt="MTG Logo"
              style="margin-left: 40px; height: 70px;">
          </a>
          <a target="_blank" href="https://www.upf.edu/web/mtg">
            <img class="essnt-footer_mtg-logo" src="https://mtg.github.io/assets/img/upflogo.png" alt="mtg logo"
                style="width:300px; height: 70px;">
          </a>
        </div>
        </center>
      
        <script>
            // global var to load essentia instance from wasm build
            let essentia;
            // global var for web audio api AudioContext
            let audioCtx;
            // buffer size microphone stream (bufferSize is high in order to make PitchYinProbabilistic algo to work)
            let bufferSize = 8192;

            try {
              const AudioContext = window.AudioContext || window.webkitAudioContext;
              audioCtx = new AudioContext();
              } 
            catch (e) {
              throw 'Could not instantiate AudioContext: ' + e.message;
            }
      
            $(document).ready(function () {
              // add event listeners to ui objects
              $('#recordButton').click(function () {
                var recording = $(this).hasClass('recording');
                if (!recording) {
                  $(this).prop("disabled", true);
                  startMicRecordStream(audioCtx, bufferSize, onRecordEssentiaFeatureExtractor, function() {
                    // called when the promise fulfilled
                    $('#recordButton').addClass('recording');
                    $('#recordButton').html('Stop &nbsp;&nbsp;<i class="stop icon"></i>');
                    $('#recordButton').prop("disabled", false);
                  });
                } else {
                    stopMicRecordStream();
                }
              }); // end recordButton onClick
                
            });
        </script>
      </body>
</html>