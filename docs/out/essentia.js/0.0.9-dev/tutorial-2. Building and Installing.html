<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>essentia.js: Tutorial: 2. Building and Installing</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Tutorial: 2. Building and Installing</h1>

    <section>

<header>
    

    <h2>2. Building and Installing</h2>
</header>

<article>
    <h1>Building and installing essentia.js from source</h1>
<p>You can find pre-compiled builds of <code>essentia.js</code> <a href="https://github.com/MTG/essentia.js/releases">here</a>.</p>
<p>In order to build the associate <code>essentia.js</code> builds we need to first compile essentia C++ library using emscripten compiler.</p>
<p>If you need to recompile the builds yourself, you can either use the <a href="https://docs.docker.com/install/">docker</a> (recommended) or build everything from source on your local system.</p>
<h2>Using docker</h2>
<ul>
<li>
<p>Pull the official <a href="https://hub.docker.com/r/mtgupf/essentia-emscripten"><code>essentia-emscripten</code></a> docker image.</p>
<pre class="prettyprint source lang-bash"><code>docker pull mtgupf/essentia-emscripten:2.1-beta5-dev
</code></pre>
</li>
<li>
<p>Clone or download the <a href="https://github.com/MTG/essentia.js">essentia.js</a> repo.</p>
</li>
<li>
<p><code>cd</code> to repo and mount the current directory as volume and run <code>build-bindings.sh</code> inside the docker container and check the new builds at the <code>dist/</code> directory.</p>
<pre class="prettyprint source lang-bash"><code>docker run --rm -v `pwd`:/srv/workspace/ \
                mtgupf/essentia-emscripten:2.1-beta5-dev \
                /srv/workspace/build-bindings.sh \
                Makefile.essentiajs
</code></pre>
</li>
</ul>
<p>OR</p>
<h2>Building from source locally</h2>
<ul>
<li>
<p>Install <a href="https://emscripten.org/docs/getting_started/downloads.html">emscripten</a>.</p>
</li>
<li>
<p>Clone the <a href="https://github.com/MTG/essentia.git">essentia</a> repository.</p>
<pre class="prettyprint source lang-bash"><code>git clone https://github.com/MTG/essentia.git
</code></pre>
</li>
<li>
<p>Install the required 3rd party dependencies for essentia. Check the instructions <a href="https://essentia.upf.edu/installing.html#installing-dependencies-on-linux">here</a>.</p>
</li>
<li>
<p>Compile essentia C++ library with the emscripten compiler. Check essentia <a href="https://essentia.upf.edu/documentation/installing.html#compiling-essentia">documentation</a> for more details.</p>
<pre class="prettyprint source lang-bash"><code># configure build settings for essentia using kissfft
emconfigure sh -c './waf configure --prefix=$EMSCRIPTEN/system/local/ --build-static --lightweight= --fft=KISS --emscripten'

# compile and build essentia
emmake ./waf

# (you might need sudo rights)
emmake ./waf install
</code></pre>
</li>
<li>
<p>Clone or download the <a href="https://github.com/MTG/essentia.js">essentia.js</a> repo.</p>
</li>
<li>
<p>Finally, <code>cd</code> to repo and build the <code>essentia.js</code> bindings using one of the following commands. Check the new builds at the <code>dist/</code> directory.</p>
<p>Spawn a subshell inside the emscripten <code>emconfigure</code> in order to properlly access the emscripten variables.</p>
<pre class="prettyprint source lang-bash"><code>emconfigure sh -c './build-bindings.sh Makefile.essentiajs'
</code></pre>
<p>OR</p>
<p>You can also run it from node</p>
<pre class="prettyprint source lang-bash"><code>npm run build
</code></pre>
<blockquote>
<p>Note: make you added the emscripten env variables to your bash profile.</p>
</blockquote>
</li>
</ul>
<h2>Customizing your essentia.js builds</h2>
<p>You can make customised builds of essentia.js for only a set of selected essentia standard algoithms using the following python scripts.
 enerator.py](https://github.com/MTG/essentia.js/blob/module/src/python/code_generator.py) script creates cpp source code and bindings for all the algos listed in <a href="https://github.com/MTG/essentia.js/blob/module/src/python/included_algos.md">included_algos.md</a>. This list of included algorithms can be customised using the <a href="https://github.com/MTG/essentia.js/blob/module/src/python/configure_bindings.py">configure_bindings.py</a> script.</p>
<pre class="prettyprint source lang-bash"><code>cd src/python

# configure default list of algorithms for creating the js bindings
python configure_bindings.py 

# OR
# specify a list of algorithms for which you need to create the js bindings
python configure_bindings.py -i &quot;['Key', 'HPCP']&quot;

# OR
# you can also specify the algorithm list by a txt file
python configure_bindings.py -i your_included_algos_list.txt

# for more cli options
 python configure_bindings.py -h
</code></pre>
<h2>Building custom essentia C++ extractor and cross-compile to JS</h2>
<p>You could also write  your own customised <a href="https://essentia.upf.edu/howto_standard_extractor.html">essentia feature extractor</a> in C++ and cross-compile to WASM using emscripten and our toolchain following the build instructions.</p>
<ul>
<li>
<h3>Using <a href="../src/cpp/custom/essentia_extractor.cpp"><code>EssentiaExtractor</code></a> class examples</h3>
<ul>
<li>Build using <code>make -f Makefile.essentia.extractor</code> given in the <code>src/cpp/custom/</code> directory.</li>
</ul>
</li>
<li>
<h3>Write custom extractor in C++ from scratch.</h3>
<ul>
<li>An example of custom essentia C++ extractor with embind bindings. Here we write an extractor for computing log mel-scaled spectrogram from an input audio signal.</li>
</ul>
<pre class="prettyprint source lang-c++"><code>#include &lt;stdio.h>
#include &lt;essentia/algorithmfactory.h>
#include &lt;essentia/essentiamath.h>
#include &lt;essentia/pool.h>
#include &lt;emscripten/bind.h>

using namespace essentia;
using namespace essentia::standard;
using namespace emscripten;

std::vector&lt;float> logMelSpectrogramExtractor(std::vector&lt;float>& signal, int numBands, int frameSize, int hopSize, std::string windowType) {
  // we want to compute the MFCC of a input signal: we need the create the following:
  // vector -> framecutter -> windowing -> FFT -> MFCC 
  AlgorithmFactory& factory = standard::AlgorithmFactory::instance();

  Algorithm* fc = factory.create(&quot;FrameCutter&quot;,
                  &quot;frameSize&quot;, frameSize,
                &quot;hopSize&quot;, hopSize,
                &quot;startFromZero&quot;, true);

  Algorithm* w = factory.create(&quot;Windowing&quot;,
                  &quot;type&quot;, windowType,
                &quot;zeroPadding&quot;, frameSize);

  Algorithm* spec = factory.create(&quot;Spectrum&quot;,
                  &quot;size&quot;, frameSize);

  Algorithm* mel = factory.create(&quot;MelBands&quot;,
                  &quot;numberBands&quot;, numBands,
                  &quot;type&quot;, &quot;magnitude&quot;);

  Algorithm* logNorm = factory.create(&quot;UnaryOperator&quot;,
                    &quot;type&quot;, &quot;log&quot;);							   
  /////////// STARTING THE ALGORITHMS //////////////////
  fc->input(&quot;signal&quot;).set(signal);
  // FrameCutter -> Windowing -> Spectrum
  std::vector&lt;Real> frame, windowedFrame;
  fc->output(&quot;frame&quot;).set(frame);
  w->input(&quot;frame&quot;).set(frame);
  w->output(&quot;frame&quot;).set(windowedFrame);
  spec->input(&quot;frame&quot;).set(windowedFrame);
  // Spectrum -> MFCC
  std::vector&lt;Real> spectrum, mfccBands, melBands;
  spec->output(&quot;spectrum&quot;).set(spectrum);
  mel->input(&quot;spectrum&quot;).set(spectrum);
  mel->output(&quot;bands&quot;).set(mfccBands);
  logNorm->input(&quot;array&quot;).set(mfccBands);
  logNorm->output(&quot;array&quot;).set(melBands);
  while (true) {
    // compute a frame
    fc->compute();
    // if it was the last one (ie: it was empty), then we're done.
    if (!frame.size()) {
      break;
    }
    // if the frame is silent, just drop it and go on processing
    if (isSilent(frame)) continue;
    w->compute();
    spec->compute();
    mel->compute();
    logNorm->compute();
  }
  delete fc;
  delete w;
  delete spec;
  delete mel;
  delete logNorm;
  return melBands;
}

EMSCRIPTEN_BINDINGS(es_extractor) {
  function(&quot;logMelSpectrogramExtractor&quot;, &logMelSpectrogramExtractor);
  register_vector&lt;float>(&quot;VectorFloat&quot;);
}

</code></pre>
<ul>
<li>Build it using Emscripten compiler.</li>
</ul>
<pre class="prettyprint source lang-bash"><code>emcc --bind -Oz -s WASM=1 $(YOUR_CPP_FILE) $(EMSCRIPTEN)/system/local/lib/essentia.a  $(YOUR_OUTPUT.js) -s EXCEPTION_DEBUG -s ASSERTIONS=2-s ALLOW_MEMORY_GROWTH=1 
</code></pre>
<ul>
<li>Usage on JavaScript would be like</li>
</ul>
<pre class="prettyprint source lang-JavaScript"><code>Module.logMelSpectrogramExtractor(inputSignal, // std::vector&lt;float> type array
                                  128, // numBands
                                  4096, // frameSize
                                  2048, // hopSize
                                  'hann'); // windowType
</code></pre>
</li>
</ul>
<p> </p>
</article>

</section>

</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Essentia.html">Essentia</a></li><li><a href="EssentiaExtractor.html">EssentiaExtractor</a></li><li><a href="EssentiaPlot.html">EssentiaPlot</a></li><li><a href="PlotHeatmap.html">PlotHeatmap</a></li><li><a href="PlotMelodyContour.html">PlotMelodyContour</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-1. Getting Started.html">1. Getting Started</a></li><li><a href="tutorial-2. Building and Installing.html">2. Building and Installing</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Thu Mar 19 2020 18:06:43 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>